<!DOCTYPE html>
<html lang="en">

<head lang="ko">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- HTML Meta Tags -->
  <title>AWS Athena ë¡œê·¸ í™•ì¸</title>
  <meta name="description" content="ê¸€ë¡œìš°ë°ì´ì¦ˆ ê¸°ìˆ ë¸”ë¡œê·¸">

  <!-- Naver Search Engine Tag -->
<!--  <meta name="naver-site-verification" content="55cc2fd19a3823b9a891312ff941dff197dc77be" />-->

  <!-- Google / Search Engine Tags -->
  <meta itemprop="name" content="AWS Athena ë¡œê·¸ í™•ì¸">
  <meta itemprop="description" content="ê¸€ë¡œìš°ë°ì´ì¦ˆ ê¸°ìˆ ë¸”ë¡œê·¸">
  <meta itemprop="image" content="/tech/2111091608/img/athena_dashboard.png">

  <!-- Facebook Meta Tags -->
  <!-- <meta property="og:url" content=""> -->
  <meta property="og:type" content="article">
  <meta property="og:title" content="AWS Athena ë¡œê·¸ í™•ì¸">
  <meta property="og:description" content="ê¸€ë¡œìš°ë°ì´ì¦ˆ ê¸°ìˆ ë¸”ë¡œê·¸">
  <meta property="og:image" content="/tech/2111091608/img/athena_dashboard.png">
  <meta property="og:image:width" content="1600">
  <meta property="og:image:height" content="900">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="AWS Athena ë¡œê·¸ í™•ì¸">
  <meta name="twitter:description" content="ê¸€ë¡œìš°ë°ì´ì¦ˆ ê¸°ìˆ ë¸”ë¡œê·¸">
  <meta name="twitter:image" content="/tech/2111091608/img/athena_dashboard.png">

  <!-- CSS -->
  <link rel="stylesheet" href="/styles.css">
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,700" rel="stylesheet">
  <link rel="shortcut icon" type="image/x-icon" href="/meta/favicon.ico">

  <!-- Script -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-212893940-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-212893940-1');
  </script>

</head>




<body>


<script>
  function switchMenuVisible() {
      if ($('ul').hasClass('hide')) {
          $('ul').removeClass('hide');
      } else {
          $('ul').addClass('hide');
      }
  }
</script>

<nav class="nav">
  <div class="nav-container">

    <div class="logo">
      <a href="/">
        <img src="https://www.glowpick.com/_nuxt/img/glowpick-banner-icon.3e85e74.svg">
        <span>ê¸€ë¡œìš°ë°ì´ì¦ˆ ê¸°ìˆ ë¸”ë¡œê·¸</span>
      </a>
    </div>

    <ul class="hide">
      
      <li class="transition">
        <a href="/about" >
          ê°œë°œíŒ€ ì†Œê°œ
        </a>
      </li>
      
      <li class="transition">
        <a href="/tech"  class="active" >
          í…Œí¬ë…¸íŠ¸
        </a>
      </li>
      
      <li class="transition">
        <a href="/recruit" >
          ì±„ìš© ì •ë³´
        </a>
      </li>
      
    </ul>

    <div class="dropdown" onclick="switchMenuVisible()">
      <div class="icon">â˜°</div>
    </div>
  </div>
</nav>







<div class="post-header loading-animation" style="background-image: url('img/athena_dashboard.png')">
</div>



<main>
  <div class="post">
    <div class="post-info">
        <div class="post-type-tag">
            
            <div class="post-type">
                AWS
            </div>
        </div>
        <h1 class="post-title">
            AWS Athena ë¡œê·¸ í™•ì¸
        </h1>
        <h2 class="post-subtitle">
            AWS Athenaë¥¼ í™œìš©í•œ ì¿¼ë¦¬ë¡œ ë¡œê·¸ ì§ˆì˜í•˜ê¸°
        </h2>
        <h2 class="post-date">
            2021-11-09 16:08
        </h2>
    </div>

    <!--draft ì¼ ë•Œ-->

    

    <hr />

<p>ë³¸ í¬ìŠ¤íŒ…ì€ ì œê°€ ë…¸ì…˜ì— 2021ë…„ 07ì›”ì— ì •ë¦¬í•œ ê²ƒì„ ìµœëŒ€í•œ ì •ë¦¬ë¥¼ í•˜ì—¬ì„œ íšŒì‚¬ ê°œë°œ ë¸”ë¡œê·¸ì— ì •ë¦¬í•œ ë‚´ìš©ì…ë‹ˆë‹¤. ë¶€ì¡±í•˜ë”ë¼ë„ ì´í•´í•´ì£¼ì„¸ìš”. ê°ì‚¬í•©ë‹ˆë‹¤.</p>

<p>ì—¬ëŸ¬ë¶„ ì•ˆë…•í•˜ì„¸ìš” ê¸€ë¡œìš°í”½ì—ì„œ ë°± ì—”ë“œ ê°œë°œì„ ë§¡ì€ ê¹€ëŒ€ì„±ì…ë‹ˆë‹¤. ìƒê°ë³´ë‹¤ ë¸”ë¡œê·¸ë¡œ ìì£¼ ì¸ì‚¬ë“œë¦¬ê²Œ ë˜ë„¤ìš” :)  ì˜¤ëŠ˜ì€ ì €í¬ ìª½ AWS ELB ì•¡ì„¸ìŠ¤ ë¡œê·¸ë¥¼ ê°€ì§€ê³  Athenaì—ì„œ ë¡œê·¸ ë‚´ì—­ ì¿¼ë¦¬ë¡œ í™•ì¸í•˜ëŠ” ê¸€ì„ ì¨ë³¼ê¹Œ í•©ë‹ˆë‹¤.
ì´ë¯¸ ì˜ˆì „ì— ê¸‰í•  ë•Œ ì£¼ë¡œ ì“°ë‹¤ê°€ ì´ì°¸ì— ì •ë¦¬í•˜ê³  ì´ ê¸€ì„ ì“°ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ¤”</p>
<hr />

<h2 id="athenaë€">Athenaë€?</h2>
<p><a href="https://aws.amazon.com/ko/athena/?whats-new-cards.sort-by=item.additionalFields.postDateTime&amp;whats-new-cards.sort-order=desc">Amazon Athena</a>ëŠ” í‘œì¤€ SQLì„ ì‚¬ìš©í•´ Amazon S3ì— ì €ì¥ëœ ë°ì´í„°ë¥¼ ê°„í¸í•˜ê²Œ ë¶„ì„í•  ìˆ˜ ìˆëŠ” ëŒ€í™”ì‹ ì¿¼ë¦¬ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.</p>

<p>AthenaëŠ” ì‚¬ìš©ì´ ì‰½ìŠµë‹ˆë‹¤. Amazon S3ì— ì €ì¥ëœ ë°ì´í„°ë¥¼ ê°€ë¦¬í‚¤ê³  ìŠ¤í‚¤ë§ˆë¥¼ ì •ì˜í•œ í›„ í‘œì¤€ SQLì„ ì‚¬ìš©í•˜ì—¬ ì§ˆì˜ë¥¼ ì‹œì‘í•˜ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ ëŒ€ë¶€ë¶„ ê²°ê³¼ê°€ ìˆ˜ ì´ˆ ì´ë‚´ì— ì œê³µë©ë‹ˆë‹¤. Athenaì—ì„œëŠ” ë°ì´í„° ë¶„ì„ì„ ì¤€ë¹„í•˜ê¸° ìœ„í•œ ë³µì¡í•œ ETL ì‘ì—…ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤. ë”°ë¼ì„œ SQLì„ ë‹¤ë£° ìˆ˜ ìˆëŠ” ì‚¬ëŒì€ ëˆ„êµ¬ë‚˜ ì‹ ì†í•˜ê²Œ ëŒ€ê·œëª¨ ë°ì´í„° ì„¸íŠ¸ë¥¼ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

<p>ê³µì‹ ì‚¬ì´íŠ¸ì—ì„œëŠ” ì„¤ëª…ì´ ì´ë ‡ê²Œ ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>

<p><br /></p>

<h2 id="athena-ë„ì…-ë°°ê²½">Athena ë„ì… ë°°ê²½</h2>
<p>ELBì—ì„œ ìì²´ì ì¸ ë¡œê·¸ëŠ” í™œì„±í™”ì˜€ì§€ë§Œ í•„ìš”í•œ ì‹œì ì—ì„œ ì¥ì• ë“  ì§€ì†ì ì¸ ìš”ì²­ì´ìŠˆì´ë“  ê¸‰í•˜ê²Œ ì²˜ë¦¬í•  ë•Œê°€ í•„ìš”í•  ë•Œ ë‹¨ìˆœ ELB ì•¡ì„¸ìŠ¤ ë¡œê·¸ë¥¼ ì¼ì¼ì´
ì‚¬ìš©ìê°€ íŒŒì•…í•˜ì§€ ì•Šê³  AWSì—ì„œ ê¸°ì¡´ ë¡œê·¸ íŒŒì¼ì„ ê°€ì§€ê³  ë°ì´í„° ì§ˆì˜ë¥¼ ë‚ ë¦´ ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ê°€ ìˆë‹¤ê³  í•´ì„œ ë„ì…í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>

<p><br /></p>

<h2 id="athena-ì‚¬ì „-ì…‹íŒ…">Athena ì‚¬ì „ ì…‹íŒ…</h2>

<h3 id="1ë¡œë“œ-ë°¸ëŸ°ì„œ-ì†ì„±-í¸ì§‘">1.ë¡œë“œ ë°¸ëŸ°ì„œ ì†ì„± í¸ì§‘</h3>
<p>ë¨¼ì € ë¡œë“œ ë°¸ëŸ°ì„œì˜ ì•¡ì„¸ìŠ¤ ë¡œê·¸ë¥¼ í™œì„±í™”ë¥¼ í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤. ë¡œê·¸ ìœ„ì¹˜ëŠ” ì§€ì •í•  ìˆ˜ ìˆìœ¼ë‹ˆ ì°¸ê³ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.</p>

<p><img src="img/athena_setting1.png" /></p>

<h3 id="2athena-ê¶Œí•œ">2.Athena ê¶Œí•œ</h3>
<p>ì €í¬ëŠ” ì¼ë‹¨ í…ŒìŠ¤íŠ¸ë¥¼ í•  ì˜ˆì •ì´ë¼ ë¨¼ì € AthenaFullAccessë¡œ ë¨¼ì € ì£¼ì—ˆìŠµë‹ˆë‹¤. ì¶”í›„ì— ê¶Œí•œì€ ìˆ˜ì •ì„ í•˜ì…”ì•¼í•©ë‹ˆë‹¤.</p>

<h3 id="3athena-ì¿¼ë¦¬-ì—ë””í„°ë¡œ-ê°€ì„œ-í…Œì´ë¸”ì„-ìƒì„±">3.Athena ì¿¼ë¦¬ ì—ë””í„°ë¡œ ê°€ì„œ í…Œì´ë¸”ì„ ìƒì„±</h3>

<p><strong>ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="syntax"><code>create database elb_db;
</code></pre></div></div>

<p><br /></p>

<p><strong>í…Œì´ë¸” ìƒì„±</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="syntax"><code>CREATE EXTERNAL TABLE IF NOT EXISTS elb_glowpick_net_logs (
            type string,
            time string,
            elb string,
            client_ip string,
            client_port int,
            target_ip string,
            target_port int,
            request_processing_time double,
            target_processing_time double,
            response_processing_time double,
            elb_status_code string,
            target_status_code string,
            received_bytes bigint,
            sent_bytes bigint,
            request_verb string,
            request_url string,
            request_proto string,
            user_agent string,
            ssl_cipher string,
            ssl_protocol string,
            target_group_arn string,
            trace_id string,
            domain_name string,
            chosen_cert_arn string,
            matched_rule_priority string,
            request_creation_time string,
            actions_executed string,
            redirect_url string,
            lambda_error_reason string,
            target_port_list string,
            target_status_code_list string,
            new_field string
            )
            PARTITIONED BY(year string, month string, day string) 
						ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.RegexSerDe'
						WITH SERDEPROPERTIES (
            'serialization.format' = '1',
            'input.regex' = 
        '([^ ]*) ([^ ]*) ([^ ]*) ([^ ]*):([0-9]*) ([^ ]*)[:-]([0-9]*) ([-.0-9]*) ([-.0-9]*) ([-.0-9]*) (|[-0-9]*) (-|[-0-9]*) ([-0-9]*) ([-0-9]*) \"([^ ]*) ([^ ]*) (- |[^ ]*)\" \"([^\"]*)\" ([A-Z0-9-]+) ([A-Za-z0-9.-]*) ([^ ]*) \"([^\"]*)\" \"([^\"]*)\" \"([^\"]*)\" ([-.0-9]*) ([^ ]*) \"([^\"]*)\" \"([^\"]*)\" \"([^ ]*)\" \"([^\s]+)\" \"([^\s]+)\"(.*)')						
LOCATION 's3:ë¡œê·¸ê²½ë¡œ';

</code></pre></div></div>
<p>elbì—ì„œ ì‹¤ì œë¡œ ì•¡ì„¸ìŠ¤ ë¡œê·¸ì— ìŒ“ì„ë•Œ í•„ìš”í•œ í•­ëª©ë“¤ì„ ì´ë ‡ê²Œ athena í…Œì´ë¸”ì— ëª…ì‹œí•´ì¤ë‹ˆë‹¤.
ìì„¸í•œ í•­ëª©ì— ëŒ€í•œ ì„¤ëª…ì€ <a href="https://docs.aws.amazon.com/ko_kr/athena/latest/ug/create-table.html">Athena Create-Table</a> ì°¸ê³ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.</p>

<p><br /></p>

<p><strong>íŒŒí‹°ì…˜ ë°ì´í„° ë°€ì–´ë„£ëŠ”ë²•</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="syntax"><code>ALTER TABLE elb_db.elb_glowpick_net_logs add partition (year="2020", month="07", day="10")
location "ë¡œê·¸ê²½ë¡œ/2020/07/10";
</code></pre></div></div>
<p><a href="https://docs.aws.amazon.com/ko_kr/athena/latest/ug/alter-table-add-partition.html">ê³µì‹ ë¬¸ì„œ -&gt; íŒŒí‹°ì…˜</a>ì—ì„œëŠ” ì´ë ‡ê²Œ ì •ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>

<p>í…Œì´ë¸”ì— ëŒ€í•´ í•˜ë‚˜ ì´ìƒì˜ íŒŒí‹°ì…˜ ì—´ì„ ë§Œë“­ë‹ˆë‹¤. ê° íŒŒí‹°ì…˜ì€ í•˜ë‚˜ ì´ìƒì˜ ê°œë³„ ì—´ ì´ë¦„/ê°’ ì¡°í•©ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤
ì§€ì •ëœ ê°ê°ì˜ ì¡°í•©ì— ë³„ê°œì˜ ë°ì´í„° ë””ë ‰í„°ë¦¬ê°€ ìƒì„±ë˜ì–´ ìƒí™©ì— ë”°ë¼ ì¿¼ë¦¬ ì„±ëŠ¥ì„ ê°œì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¶„í• ëœ ì—´ì€ í…Œì´ë¸” ë°ì´í„° ìì²´ ë‚´ì— ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ í…Œì´ë¸” ìì²´ì˜ ì—´ê³¼ ì´ë¦„ì´ ê°™ì€ ì—´ ì´ë¦„ì„ ì‚¬ìš©í•˜ë©´ ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤. 
ìì„¸í•œ ë‚´ìš©ì€ <a href="https://docs.aws.amazon.com/ko_kr/athena/latest/ug/partitions.html">ë°ì´í„° íŒŒí‹°ì…”ë‹ì„ ì°¸ì¡°</a></p>

<p><strong>ì¿¼ë¦¬ ì˜ˆì‹œ</strong></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="syntax"><code><span class="k">select</span> 
    <span class="k">type</span><span class="p">,</span>
    <span class="nb">time</span><span class="p">,</span>
    <span class="n">elb</span><span class="p">,</span>
    <span class="n">client_ip</span><span class="p">,</span>
    <span class="n">client_port</span><span class="p">,</span>
    <span class="n">target_ip</span><span class="p">,</span>
    <span class="n">target_port</span><span class="p">,</span>
    <span class="n">elb_status_code</span><span class="p">,</span>
    <span class="n">request_verb</span><span class="p">,</span>
    <span class="n">request_url</span><span class="p">,</span>
    <span class="n">user_agent</span> 
<span class="k">from</span> <span class="n">elb_glowpick_net_logs</span> 
<span class="k">where</span> <span class="n">regexp_like</span><span class="p">(</span><span class="n">elb</span><span class="p">,</span><span class="s1">'admin'</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="nb">time</span> <span class="k">desc</span> <span class="k">LIMIT</span> <span class="mi">5</span><span class="p">;</span>
</code></pre></div></div>

<p><br /></p>

<p><strong>ê²°ê³¼</strong></p>

<p><img src="img/athena_dashboard_result.png" /></p>

<p><strong>íŒìœ¼ë¡œ ê¸°ê°„ë³„ë¡œ íŒŒí‹°ì…˜ ë°€ì–´ë„£ì„ë•ŒëŠ”</strong></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="syntax"><code>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">elb_db</span><span class="p">.</span><span class="n">elb_api_j_glowpick_com_logs</span> <span class="k">ADD</span> 
    <span class="n">PARTITION</span> <span class="p">(</span><span class="nb">year</span><span class="o">=</span><span class="s1">'2020'</span><span class="p">,</span><span class="k">month</span><span class="o">=</span><span class="s1">'09'</span><span class="p">,</span><span class="k">day</span><span class="o">=</span><span class="s1">'01'</span><span class="p">)</span> <span class="k">LOCATION</span> <span class="s1">'s3://elb-access-log.glowpick/api-j.glowpick.com/AWSLogs/436582069789/elasticloadbalancing/ap-northeast-2/2020/09/01'</span>
    <span class="n">PARTITION</span> <span class="p">(</span><span class="nb">year</span><span class="o">=</span><span class="s1">'2020'</span><span class="p">,</span><span class="k">month</span><span class="o">=</span><span class="s1">'09'</span><span class="p">,</span><span class="k">day</span><span class="o">=</span><span class="s1">'30'</span><span class="p">)</span> <span class="k">LOCATION</span> <span class="s1">'s3://elb-access-log.glowpick/api-j.glowpick.com/AWSLogs/436582069789/elasticloadbalancing/ap-northeast-2/2020/09/30'</span><span class="p">;</span>

</code></pre></div></div>

<p><br /></p>

<h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°</h2>
<p>ìš”ì¦˜ì€ AWS OpenSearchì—ì„œë„ ë¡œê·¸ ìì²´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆê²Œ ì„¸íŒ…ë˜ì–´ìˆì§€ë§Œ ì´ë ‡ê²Œ s3 ì•¡ì„¸ìŠ¤ ë¡œê·¸ë¡œ Athenaë¥¼ í™œìš©í•œ ë°ì´í„° ì§ˆì˜ë¥¼
ì§ˆì˜í•  ìˆ˜ ìˆë‹¤ëŠ” ê±° ìì²´ì— ê¸‰í•  ë•Œ ì“¸ë§Œí•œ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ğŸ˜€</p>


    
    <div class="post-tags">
        <div class="post-tags">
    
        <span class="tag-emoji"></span>
        
        <a href="/tech/?tag=AWS"><span class="tag" data-tag="AWS">AWS</span></a>
        
        <a href="/tech/?tag=Athena"><span class="tag" data-tag="Athena">Athena</span></a>
        
    
</div>

    </div>
    

    
<div class='post-footer'>
  <div class="member_card">
    <div class="thumbnail-container">
      <div class='thumbnail'>
        
        <img class='profile' src='/about/img/1.png'/>
        <div class='emoji'>
          <span>ğŸ¯â€ï¸</span>
        </div>
      </div>
      <div class='name'>ë·°í‹°ë·°í‹°ë§¨</div>
    </div>
    <div class='description'>ëŠ˜ í”¼ê³¤í•œ ìƒíƒœì˜ ê°œë°œìì…ë‹ˆë‹¤.</div>
  </div>
</div>

    
        <script src="https://utteranc.es/client.js"
                repo="glowpick-service/tech-blog-comment"
                issue-term="pathname"
                theme="preferred-color-scheme"
                crossorigin="anonymous"
                async>
        </script>
    
</div>

</main>

<footer>
    <address class="footer_wrap">
        <div class="copyright">
            Â© GLOWDAYZ. All rights reserved. Powered by GitHub Pages.
        </div>
    </address>
</footer>


</body>
</html>
